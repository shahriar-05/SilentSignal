import cv2
from ultralytics import YOLO
from deepface import DeepFace
import numpy as np
import matplotlib.pyplot as plt
from collections import deque

# --- SETTINGS ---
emotion_score = {
    'happy': 80, 'neutral': 50, 'sad': 20, 
    'angry': 25, 'fear': 15, 'disgust': 10, 'surprise': 60
}

# Buffer to store the last 50 points of the wave
wave_data = deque(maxlen=50) 
wave_data.extend([50] * 50) # Initialize with neutral values

# Setup the Matplotlib figure for the "Live Pattern"
plt.ion() # Interactive mode on
fig, ax = plt.subplots(figsize=(6, 3))
line, = ax.plot(np.arange(50), wave_data, color='#4ade80', linewidth=2) # Greenish like your UI
ax.set_ylim(0, 100)
ax.set_title("Live Emotional Pattern")
ax.axis('off') # Hide axes to match the dashboard look

# --- DETECTION SETUP ---
model = YOLO("yolov8n-face.pt")
cap = cv2.VideoCapture(0)
frame_count = 0

while True:
    ret, frame = cap.read()
    if not ret: break
    frame_count += 1

    results = model(frame, conf=0.5, verbose=False)
    current_score = 50 # Default to neutral if no face found

    for r in results:
        for box in r.boxes:
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            face = frame[y1:y2, x1:x2]

            try:
                # To speed up, we only analyze emotion every 3 frames
                if frame_count % 3 == 0:
                    analysis = DeepFace.analyze(face, actions=['emotion'], 
                                              enforce_detection=False, silent=True)
                    emotion = analysis[0]['dominant_emotion']
                    current_score = emotion_score.get(emotion, 50)

                # UI Overlay
                cv2.rectangle(frame, (x1, y1), (x2, y2), (74, 222, 128), 2)
                cv2.putText(frame, f"Score: {current_score}", (x1, y1-10),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.6, (74, 222, 128), 2)
            except:
                continue

    # --- WAVE GENERATION ---
    # Low score = higher chaos (noise) and higher frequency
    chaos_factor = (100 - current_score) / 100
    noise = np.random.uniform(-10, 10) * chaos_factor
    
    # Calculate a smooth wave point using a sine function + noise
    # The frequency increases as the score drops
    new_point = 50 + (20 * np.sin(frame_count * (0.2 + chaos_factor))) + noise
    wave_data.append(new_point)

    # Update the Matplotlib Wave Plot
    line.set_ydata(wave_data)
    # Change color based on distress: Green for high score, Red for low
    if current_score < 30:
        line.set_color('#ef4444') # Red
    else:
        line.set_color('#4ade80') # Green
        
    fig.canvas.draw()
    fig.canvas.flush_events()

    cv2.imshow("Detection Feed", frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()